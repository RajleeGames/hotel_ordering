{% extends 'base.html' %}
{% load static %}
{% block title %}Menu{% endblock %}
{% block content %}
<!-- Page Title -->
<h1 class="mb-4 text-center">Our Menu</h1>

<!-- Flash Messages -->
{% if messages %}
  <div id="flash-messages" class="position-fixed top-0 end-0 m-3" style="z-index: 1050;">
    {% for message in messages %}
      <div class="alert alert-success animate__animated animate__slideInDown" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
  <script>
    // Hide flash messages after 4 seconds with a fade-out animation.
    setTimeout(function(){
      document.querySelectorAll('#flash-messages .alert').forEach(function(alert){
        alert.classList.remove('animate__slideInDown');
        alert.classList.add('animate__slideOutUp');
        setTimeout(function(){
          alert.style.display = 'none';
        }, 1000);
      });
    }, 4000);
  </script>
{% endif %}

<!-- Search Form -->
<form method="GET" action="{% url 'menu' %}" class="row g-3 mb-4">
  <div class="col-md-6">
    <input type="text" name="q" value="{{ query }}" class="form-control" placeholder="Search for food items...">
  </div>
  <div class="col-md-4">
    <select name="category" class="form-select">
      <option value="">All Categories</option>
      {% for cat in categories %}
        <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == selected_category %}selected{% endif %}>{{ cat.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-primary w-100">Search</button>
  </div>
</form>

<!-- Track Your Order Link with Fancy Animation -->
{% if order %}
  <div class="text-center mb-4">
    <a href="{% url 'track_order' order.id %}" class="btn btn-warning animate__animated animate__pulse animate__infinite">
      Track Your Order
    </a>
  </div>
{% endif %}

<!-- Clear Search Button (shows only if search is active) -->
{% if query or selected_category %}
  <div class="row mb-4">
    <div class="col-12">
      <a href="{% url 'menu' %}" class="btn btn-secondary">Clear Search</a>
    </div>
  </div>
{% endif %}

{% if not grouped %}
  <h2 class="mb-3">Search Results</h2>
  <div class="row g-3">
    {% for item in food_items %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm animate__animated animate__fadeInUp">
          <div class="position-relative">
            {% if item.image %}
              <img src="{{ item.image.url }}" class="card-img-top img-fluid rounded-top" alt="{{ item.name }}">
            {% else %}
              <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top img-fluid rounded-top" alt="{{ item.name }}">
            {% endif %}
            <!-- Optional badge overlay -->
            <span class="badge bg-primary position-absolute top-0 start-0 m-2">New</span>
          </div>
          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ item.name }}</h5>
            <p class="card-text text-muted mb-3">Tsh{{ item.price }}</p>
            <p class="card-text flex-grow-1">{{ item.description|truncatewords:10 }}</p>
            <!-- Quantity Form -->
            <form method="POST" action="{% url 'add_to_cart' item.id %}">
              {% csrf_token %}
              <div class="input-group mb-2">
                <label class="input-group-text" for="quantity_{{ item.id }}">Qty</label>
                <input type="number" name="quantity" id="quantity_{{ item.id }}" value="1" min="1" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-success w-100">Add to Cart</button>
            </form>
          </div>
        </div>
      </div>
    {% empty %}
      <p class="text-center">No food items match your search criteria.</p>
    {% endfor %}
  </div>
  
  <!-- Pagination Controls -->
  {% if page_obj.has_other_pages %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?q={{ query }}&category={{ selected_category }}&page={{ page_obj.previous_page_number }}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&laquo;</span>
      </li>
      {% endif %}
      
      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item"><a class="page-link" href="?q={{ query }}&category={{ selected_category }}&page={{ num }}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}
      
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?q={{ query }}&category={{ selected_category }}&page={{ page_obj.next_page_number }}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <span class="page-link" aria-hidden="true">&raquo;</span>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
  
{% else %}
  <!-- Default Grouped by Category (when no filters are active) -->
  {% for category in categories %}
    <div class="mb-5">
      <h2 class="mb-3">{{ category.name }}</h2>
      <div class="row g-3">
        {% for item in food_items %}
          {% if item.category == category %}
            <div class="col-6 col-md-4 col-lg-3">
              <div class="card h-100 shadow-sm animate__animated animate__fadeInUp">
                <div class="position-relative">
                  {% if item.image %}
                    <img src="{{ item.image.url }}" class="card-img-top img-fluid rounded-top" alt="{{ item.name }}">
                  {% else %}
                    <img src="https://via.placeholder.com/300x200?text=No+Image" class="card-img-top img-fluid rounded-top" alt="{{ item.name }}">
                  {% endif %}
                  <span class="badge bg-primary position-absolute top-0 start-0 m-2">New</span>
                </div>
                <div class="card-body d-flex flex-column">
                  <h5 class="card-title">{{ item.name }}</h5>
                  <p class="card-text text-muted mb-3">Tsh{{ item.price }}</p>
                  <p class="card-text flex-grow-1">{{ item.description|truncatewords:10 }}</p>
                  <form method="POST" action="{% url 'add_to_cart' item.id %}">
                    {% csrf_token %}
                    <div class="input-group mb-2">
                      <label class="input-group-text" for="quantity_{{ item.id }}">Qty</label>
                      <input type="number" name="quantity" id="quantity_{{ item.id }}" value="1" min="1" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Add to Cart</button>
                  </form>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}
